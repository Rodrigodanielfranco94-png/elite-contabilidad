<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Cleaners Pro - Registro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-slate-900 text-white p-4 pb-20">
    <h1 class="text-xl font-bold mb-6 text-center text-blue-400 uppercase tracking-wider">Elite Cleaners - Registro Pro</h1>
    
    <div class="space-y-4 bg-slate-800 p-6 rounded-2xl shadow-xl mb-6 border border-slate-700">
        <input type="hidden" id="editIndex" value="-1">
        
        <div class="grid grid-cols-2 gap-4">
            <div class="flex flex-col">
                <label class="text-[10px] text-slate-400 ml-1 mb-1.5 uppercase font-bold tracking-tight">Fecha del Trabajo</label>
                <input type="date" id="fecha" class="w-full bg-slate-700 p-3 rounded-xl text-white border border-slate-600 outline-none h-[52px] focus:border-blue-500 transition-all">
            </div>
            <div class="flex flex-col">
                <label class="text-[10px] text-slate-400 ml-1 mb-1.5 uppercase font-bold tracking-tight">Nombre del Cliente</label>
                <input type="text" id="cliente" class="w-full bg-slate-700 p-3 rounded-xl text-white border border-slate-600 outline-none h-[52px] focus:border-blue-500 transition-all" placeholder="Nombre">
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 pt-2">
            <div class="flex flex-col">
                <label class="text-[10px] text-slate-400 ml-1 mb-1.5 uppercase font-bold tracking-tight">Ingreso ($)</label>
                <input type="number" id="ingresos" class="bg-slate-700 p-3 rounded-xl border border-slate-600 outline-none h-[52px] focus:border-blue-500 transition-all" placeholder="0.00">
            </div>
            <div class="flex flex-col">
                <label class="text-[10px] text-slate-400 ml-1 mb-1.5 uppercase font-bold tracking-tight">Gasto Comida ($)</label>
                <input type="number" id="gastosDiarios" class="bg-slate-700 p-3 rounded-xl border border-slate-600 outline-none h-[52px] focus:border-blue-500 transition-all" placeholder="0.00">
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 pt-2">
            <div class="flex flex-col">
                <label class="text-[10px] text-slate-400 ml-1 mb-1.5 uppercase font-bold tracking-tight">Horas Staff 1</label>
                <input type="number" id="horas" class="bg-slate-700 p-3 rounded-xl border border-slate-600 outline-none h-[52px] focus:border-blue-500 transition-all" placeholder="0">
            </div>
            <div class="flex flex-col">
                <label class="text-[10px] text-slate-400 ml-1 mb-1.5 uppercase font-bold tracking-tight">Horas Staff 2</label>
                <input type="number" id="horas2" class="bg-slate-700 p-3 rounded-xl border border-slate-600 outline-none h-[52px] focus:border-blue-500 transition-all" placeholder="0">
            </div>
        </div>

        <div class="flex flex-col pt-2">
            <label class="text-[10px] text-slate-400 ml-1 mb-1.5 uppercase font-bold tracking-tight">Inversi√≥n ($) (Gasolina/L√≠quidos)</label>
            <input type="number" id="inversion" class="w-full bg-slate-700 p-3 rounded-xl border border-slate-600 outline-none h-[52px] focus:border-blue-500 transition-all" placeholder="0.00">
        </div>

        <div class="grid grid-cols-2 gap-4 pt-6 border-t border-slate-700/50">
            <div class="text-center bg-slate-900/40 p-2 rounded-lg"><p class="text-[9px] text-slate-400 uppercase">Rodrigo (35%)</p><p id="resR" class="text-md font-bold text-green-400">$0.00</p></div>
            <div class="text-center bg-slate-900/40 p-2 rounded-lg"><p class="text-[9px] text-slate-400 uppercase">Dayana (35%)</p><p id="resD" class="text-md font-bold text-green-400">$0.00</p></div>
            <div class="text-center bg-slate-900/40 p-2 rounded-lg"><p class="text-[9px] text-yellow-500 uppercase font-bold">Total Staffs</p><p id="resStaff" class="text-md font-bold text-yellow-500">$0.00</p></div>
            <div class="text-center bg-slate-900/40 p-2 rounded-lg"><p class="text-[9px] text-blue-400 uppercase font-bold">Empresa Neto</p><p id="resNeto" class="text-md font-bold text-blue-400">$0.00</p></div>
        </div>

        <button onclick="guardarRegistro()" id="btnGuardar" class="w-full bg-blue-600 py-4 rounded-2xl font-bold mt-4 shadow-lg active:scale-95 transition-all uppercase tracking-widest text-sm">Guardar Registro</button>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-8">
        <button onclick="respaldarDatos()" class="bg-slate-800 text-[10px] p-3 rounded-xl border border-slate-700 uppercase font-bold text-slate-400 shadow-sm">üíæ Crear Backup</button>
        <button onclick="document.getElementById('importInput').click()" class="bg-slate-800 text-[10px] p-3 rounded-xl border border-slate-700 uppercase font-bold text-slate-400 shadow-sm">üìÇ Restaurar</button>
        <input type="file" id="importInput" class="hidden" accept=".json" onchange="restaurarDatos(event)">
    </div>

    <h2 class="text-xs font-bold mb-3 text-slate-500 ml-2 uppercase tracking-widest">Totales Acumulados</h2>
    <div class="grid grid-cols-2 gap-4 mb-10">
        <div class="bg-green-900/20 p-4 rounded-3xl border border-green-500/30 text-center shadow-inner">
            <p class="text-[10px] text-green-500 font-bold uppercase mb-1">Total Rodrigo</p>
            <p id="totalRodrigo" class="text-xl font-black text-white">$0.00</p>
        </div>
        <div class="bg-green-900/20 p-4 rounded-3xl border border-green-500/30 text-center shadow-inner">
            <p class="text-[10px] text-green-500 font-bold uppercase mb-1">Total Dayana</p>
            <p id="totalDayana" class="text-xl font-black text-white">$0.00</p>
        </div>
        <div class="bg-yellow-900/20 p-4 rounded-3xl border border-yellow-500/30 text-center shadow-inner">
            <p class="text-[10px] text-yellow-500 font-bold uppercase mb-1">Total Staffs</p>
            <p id="totalStaff" class="text-xl font-black text-white">$0.00</p>
        </div>
        <div class="bg-blue-900/20 p-4 rounded-3xl border border-blue-500/30 text-center shadow-inner">
            <p class="text-[10px] text-blue-500 font-bold uppercase mb-1">Total Empresa</p>
            <p id="totalEmpresa" class="text-xl font-black text-white">$0.00</p>
        </div>
    </div>

    <div class="flex justify-between items-center mb-4 px-2">
        <h2 class="text-lg font-bold text-blue-300 uppercase tracking-tight">Historial</h2>
        <button onclick="exportarExcel()" class="bg-green-600 text-[10px] px-4 py-2 rounded-xl font-bold uppercase shadow-lg active:scale-95 transition-all">Exportar Excel</button>
    </div>
    
    <div id="historial" class="space-y-4 mb-10"></div>

    <div class="mt-10 pt-10 border-t border-slate-800">
        <button onclick="reiniciarMes()" class="w-full bg-red-900/40 text-red-400 border border-red-500/50 py-4 rounded-2xl font-bold text-xs uppercase tracking-[0.2em] shadow-lg active:scale-95 transition-all">
            üö® Reiniciar Mes (Cierre de Contabilidad)
        </button>
        <p class="text-[9px] text-slate-500 text-center mt-3 uppercase">Esta acci√≥n guardar√° un reporte y borrar√° el historial actual</p>
    </div>

    <script>
        const ids = ["ingresos", "gastosDiarios", "horas", "horas2", "inversion", "fecha", "cliente"];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('input', calcularPrevio);
        });

        window.onload = function() {
            mostrarHistorial();
        };

        function formatoMoneda(valor) {
            return '$' + valor.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function calcularPrevio() {
            const ing = parseFloat(document.getElementById('ingresos').value) || 0;
            const gas = parseFloat(document.getElementById('gastosDiarios').value) || 0;
            const hrs1 = parseFloat(document.getElementById('horas').value) || 0;
            const hrs2 = parseFloat(document.getElementById('horas2').value) || 0;
            const inv = parseFloat(document.getElementById('inversion').value) || 0;

            const pStaff = (hrs1 * 16) + (hrs2 * 16);
            const netoParaReparto = ing - gas; 
            const cadaUno = (netoParaReparto * 0.70) / 2;
            const eNeto = (netoParaReparto * 0.30) - inv;

            document.getElementById('resR').innerText = formatoMoneda(cadaUno);
            document.getElementById('resD').innerText = formatoMoneda(cadaUno);
            document.getElementById('resStaff').innerText = formatoMoneda(pStaff);
            document.getElementById('resNeto').innerText = formatoMoneda(eNeto);
        }

        function guardarRegistro() {
            const index = parseInt(document.getElementById('editIndex').value);
            const data = {
                fecha: document.getElementById('fecha').value || new Date().toISOString().split('T')[0],
                cliente: document.getElementById('cliente').value || "N/A",
                ing: parseFloat(document.getElementById('ingresos').value) || 0,
                gas: parseFloat(document.getElementById('gastosDiarios').value) || 0,
                hrs: parseFloat(document.getElementById('horas').value) || 0,
                hrs2: parseFloat(document.getElementById('horas2').value) || 0,
                inv: parseFloat(document.getElementById('inversion').value) || 0
            };

            if(data.ing === 0) return alert("Ingresa el monto del ingreso");

            let trabajos = JSON.parse(localStorage.getItem('elite_trabajos')) || [];
            
            if (index === -1) {
                trabajos.push(data);
            } else {
                trabajos[index] = data;
                resetBotones();
            }

            trabajos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            localStorage.setItem('elite_trabajos', JSON.stringify(trabajos));
            limpiar();
            mostrarHistorial();
        }

        function respaldarDatos() {
            const datos = localStorage.getItem('elite_trabajos');
            if(!datos || datos === "[]") return alert("No hay datos");
            const blob = new Blob([datos], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Elite_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function restaurarDatos(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const contenido = e.target.result;
                    JSON.parse(contenido);
                    localStorage.setItem('elite_trabajos', contenido);
                    mostrarHistorial();
                    alert("‚úÖ Restaurado");
                } catch (err) {
                    alert("Archivo inv√°lido");
                }
            };
            reader.readAsText(file);
        }

        function mostrarHistorial() {
            const lista = document.getElementById('historial');
            const trabajos = JSON.parse(localStorage.getItem('elite_trabajos')) || [];
            let sumR = 0, sumD = 0, sumS = 0, sumE = 0;

            if (trabajos.length === 0) {
                lista.innerHTML = '<p class="text-center text-slate-500 text-sm py-10 italic">No hay registros.</p>';
            } else {
                lista.innerHTML = trabajos.map((t, index) => {
                    const pStaff = ((t.hrs || 0) * 16) + ((t.hrs2 || 0) * 16);
                    const neta = t.ing - t.gas;
                    const cadaUno = (neta * 0.70) / 2;
                    const eNeto = (neta * 0.30) - t.inv;

                    sumR += cadaUno; sumD += cadaUno; sumS += pStaff; sumE += eNeto;

                    return `
                    <div class="bg-slate-800 p-5 rounded-2xl border-l-4 border-blue-500 shadow-lg">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex flex-col">
                                <span class="text-blue-400 font-bold text-sm">${t.fecha}</span>
                                <span class="text-white text-xs font-medium italic">Cliente: ${t.cliente}</span>
                            </div>
                            <span class="text-green-400 font-bold text-lg">${formatoMoneda(t.ing)}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-[10px]">
                            <div class="bg-slate-700/40 p-2 rounded-lg">DUE√ëOS: <b class="text-white">${formatoMoneda(cadaUno)} c/u</b></div>
                            <div class="bg-slate-700/40 p-2 rounded-lg">STAFFS: <b class="text-yellow-400">${formatoMoneda(pStaff)}</b></div>
                            <div class="bg-slate-700/40 p-2 rounded-lg col-span-2 text-center border border-slate-600/30">
                                EMPRESA NETO: <b class="text-blue-300 font-bold">${formatoMoneda(eNeto)}</b>
                            </div>
                        </div>
                        <div class="flex gap-6 mt-4 pt-3 border-t border-slate-700/50">
                            <button onclick="editarRegistro(${index})" class="text-[10px] text-blue-400 font-bold uppercase tracking-wider">‚úèÔ∏è Editar</button>
                            <button onclick="borrarUno(${index})" class="text-[10px] text-red-500 font-bold uppercase tracking-wider opacity-70">üóëÔ∏è Borrar</button>
                        </div>
                    </div>`;
                }).join('');
            }

            document.getElementById('totalRodrigo').innerText = formatoMoneda(sumR);
            document.getElementById('totalDayana').innerText = formatoMoneda(sumD);
            document.getElementById('totalStaff').innerText = formatoMoneda(sumS);
            document.getElementById('totalEmpresa').innerText = formatoMoneda(sumE);
        }

        function editarRegistro(index) {
            let trabajos = JSON.parse(localStorage.getItem('elite_trabajos'));
            const t = trabajos[index];
            document.getElementById('fecha').value = t.fecha;
            document.getElementById('cliente').value = t.cliente || "";
            document.getElementById('ingresos').value = t.ing;
            document.getElementById('gastosDiarios').value = t.gas;
            document.getElementById('horas').value = t.hrs;
            document.getElementById('horas2').value = t.hrs2 || 0;
            document.getElementById('inversion').value = t.inv;
            document.getElementById('editIndex').value = index;
            document.getElementById('btnGuardar').innerText = "Actualizar Registro";
            document.getElementById('btnGuardar').className = "w-full bg-orange-600 py-4 rounded-2xl font-bold mt-4 shadow-lg active:scale-95 transition-all uppercase tracking-widest text-sm";
            window.scrollTo({ top: 0, behavior: 'smooth' });
            calcularPrevio();
        }

        function resetBotones() {
            document.getElementById('editIndex').value = "-1";
            document.getElementById('btnGuardar').innerText = "Guardar Registro";
            document.getElementById('btnGuardar').className = "w-full bg-blue-600 py-4 rounded-2xl font-bold mt-4 shadow-lg active:scale-95 transition-all uppercase tracking-widest text-sm";
        }

        function limpiar() { 
            ids.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = "";
            }); 
            calcularPrevio(); 
        }

        function borrarUno(index) {
            if(confirm("¬øBorrar este registro?")) {
                let trabajos = JSON.parse(localStorage.getItem('elite_trabajos'));
                trabajos.splice(index, 1);
                localStorage.setItem('elite_trabajos', JSON.stringify(trabajos));
                mostrarHistorial();
            }
        }

        function exportarExcel() {
            const trabajos = JSON.parse(localStorage.getItem('elite_trabajos')) || [];
            if(trabajos.length === 0) return alert("No hay datos");
            const data = trabajos.map(t => ({
                "Fecha": t.fecha, 
                "Cliente": t.cliente || "N/A",
                "Ingresos": t.ing, 
                "Gastos Comida": t.gas, 
                "Pago Staffs Total": ((t.hrs || 0) + (t.hrs2 || 0)) * 16, 
                "Pago Rodrigo": ((t.ing-t.gas)*0.7)/2,
                "Pago Dayana": ((t.ing-t.gas)*0.7)/2, 
                "Inversi√≥n": t.inv, 
                "Empresa Neto": ((t.ing-t.gas)*0.3)-t.inv
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Contabilidad");
            XLSX.writeFile(wb, `Elite_Reporte_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // --- FUNCI√ìN DE CIERRE DE MES ---
        function reiniciarMes() {
            const trabajos = JSON.parse(localStorage.getItem('elite_trabajos')) || [];
            if(trabajos.length === 0) return alert("No hay datos para cerrar.");

            if(confirm("‚ö†Ô∏è ATENCI√ìN: Se descargar√° un Excel con el historial y se borrar√°n todos los registros para iniciar el mes en $0.00.\n\n¬øDeseas continuar?")) {
                // 1. Exportar el Excel primero por seguridad
                exportarExcel();

                // 2. Borrar del localStorage
                localStorage.removeItem('elite_trabajos');

                // 3. Limpiar vista y mostrar historial vac√≠o
                mostrarHistorial();
                alert("‚úÖ Mes reiniciado con √©xito. Reporte descargado.");
            }
        }
    </script>
</body>
</html>
